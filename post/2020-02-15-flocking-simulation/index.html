<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Flocking Behaviour Simulations</title><meta name=description content="A blog by Alejandro U. Alvarez on programming and humans"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta property="og:site_name" content="Alejandro U. Alvarez - Blog"><meta property="og:type" content="article"><meta property="og:title" content="Flocking Behaviour Simulations"><meta property="og:description" content="I&rsquo;ve always been fascinated by flocks of birds flying in the sky, when they create patterns like the ones you can see in this video:
  And as usual I&rsquo;ve thought, how hard can it be to recreate? So off we go into the next learning adventure!
State of the Art: Boid, Vicsek, Three-Circle, Social force&mldr; There is tons of research into this topic already, which is great because it should make the work a lot simpler!"><meta property="og:url" content="https://aurbano.eu/post/2020-02-15-flocking-simulation/"><meta property="article:published_time" content="2020-02-08 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2020-02-08 00:00:00 +0000 UTC"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flocking Behaviour Simulations"><meta name=twitter:description content="I&rsquo;ve always been fascinated by flocks of birds flying in the sky, when they create patterns like the ones you can see in this video:
  And as usual I&rsquo;ve thought, how hard can it be to recreate? So off we go into the next learning adventure!
State of the Art: Boid, Vicsek, Three-Circle, Social force&mldr; There is tons of research into this topic already, which is great because it should make the work a lot simpler!"><meta name=twitter:url content="https://aurbano.eu/post/2020-02-15-flocking-simulation/"><meta name=twitter:label1 content="Written by"><meta name=twitter:data1 content="Alejandro U. Alvarez"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dark.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><link rel=stylesheet href=https://aurbano.eu/main.min.f4c1102964c7cfdf005c68c3b002fb9d183e1e70ebc59a411dbfbdeb3e13c6eb.css><script src=https://code.jquery.com/jquery-3.4.1.slim.min.js integrity=sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n crossorigin=anonymous></script></head><body><nav class="navbar navbar-expand-lg navbar-light bg-light"><div class=container><button class=navbar-toggler type=button data-toggle=collapse data-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav nav-menu mr-auto"><li class=nav-item><a class=nav-link href=/ style=font-weight:700>Alejandro U. Alvarez</a></li><li class=nav-item><a class=nav-link href=/about/>About</a></li><li class=nav-item><a class=nav-link href=/post/>Posts</a></li><li class=nav-item><a class=nav-link href=/projects/>Projects</a></li></ul><ul class=navbar-nav><li class=nav-item><a title="github profile" class="nav-link text-github" href=https://github.com/aurbano/><i class="fa fa-github"></i></a></li><li class=nav-item><a title="linkedin profile" class="nav-link text-linkedin" href=https://www.linkedin.com/in/aurbano/><i class="fa fa-linkedin"></i></a></li><li class=nav-item><a title="stack-overflow profile" class="nav-link text-stack-overflow" href=https://stackoverflow.com/users/1262824/aurbano><i class="fa fa-stack-overflow"></i></a></li><li class=nav-item><a title="hacker-news profile" class="nav-link text-hacker-news" href="https://news.ycombinator.com/user?id=aurbano"><i class="fa fa-hacker-news"></i></a></li><li class=nav-item><a title="rss profile" class="nav-link text-rss" href=/index.xml><i class="fa fa-rss"></i></a></li></ul></div></div></nav><main><div class=container><div class="row justify-content-md-center"><div class="col col-lg-8"><header><h1>Flocking Behaviour Simulations</h1><div class=row><div class=col><small class="date text-muted">Published on February 8, 2020</small>
<a href=https://aurbano.eu/tags/JavaScript class=item-tag>JavaScript</a>
<a href=https://aurbano.eu/tags/Procedural class=item-tag>Procedural</a></div><div class="col-2 text-right"><a href=https://github.com/aurbano/aurbano.eu/blob/master/content/post/2020-02-15-flocking-simulation.md class=edit title="Open this post on Github"><i class="fa fa-pencil"></i></a></div></div></header><div align=start class=content><p>I&rsquo;ve always been fascinated by flocks of birds flying in the sky, when they create patterns like the ones you can see in this video:</p><div class="embed video-player"><iframe class=youtube-player type=text/html width=640 height=385 src=https://www.youtube.com/embed/V4f_1_r80RY allowfullscreen frameborder=0></iframe></div><p>And as usual I&rsquo;ve thought, how hard can it be to recreate? So off we go into the next learning adventure!</p><h2 id=state-of-the-art-boid-vicsek-three-circle-social-force>State of the Art: Boid, Vicsek, Three-Circle, Social force&mldr;</h2><p>There is tons of research into this topic already, which is great because it should make the work a lot simpler! Ideally I can focus on rendering enough points in the screen to achieve a visual effect similar to the video above. I might try each of the models to see how they look and feel, or at least the ones that don&rsquo;t require a ton of work to implement.</p><p>The first paper that I could find on flocking modelling was publised by <a href=http://www.red3d.com/cwr/boids/>Craig Reynolds in 1986</a> with a fairly simple model based on three rules that seem to have become &ldquo;the standard&rdquo;: <em>Alignment-Cohesion-Separation</em>.</p><p>Reynolds called each particle in the simulation a <em>boid</em> (bird-oid object), so I&rsquo;ll use that term throughout this post and in <a href=https://github.com/aurbano/flock-webgl>my code</a>. His three rules mean that when the boids are far from each other they&rsquo;ll fly towards other boids. When they&rsquo;re close they&rsquo;ll follow each other&rsquo;s directions, and if they get too close they&rsquo;ll separate.</p><p>So I set out to implement this and see how it looks!</p><h3 id=first-iteration-reynolds-boids>First Iteration: Reynolds&rsquo; Boids</h3><p>To keep things simple initially, I decided to simulate it in 2D, make the speed of the boids fixed and have the rules determine their flight direction only (the algorithm is detailed below the visualization).</p><p>Although my end goal is to generate a visualization that looks like the reference video, so I&rsquo;ll eventually need to go 3D and a few thousand boids.</p><p>My initial algorithm is:</p><ol><li>For each boid \( z_i \)
find all neighbours \( z_{ij} \)
within each of the radii (cohesion \( z_{ij_c} \)
, alignment \( z_{ij_a} \)
, and separation \( z_{ij_s} \)
)</li><li>For each group of neighbours \( z_{ij_k} \)
calculate the center of mass \( C_k = z_i - z_{ij_k} \)
and the angle between it and each boid: \( \theta_k = atan2(\dfrac{z_i}{C_k}) \)</li><li>Update the boid&rsquo;s direction \( \theta_i(t+1) = \theta_i(t) + c_k(\theta_k - \theta_i) \)
where \( c_k \)
is the coefficient for that rule.</li></ol><p>Below I have embedded a CodePen with the code I have at this stage: (Green indicates that a boid is aligned to others. The mouse behaves like a predator, so boids will try to avoid it and turn red while doing so)</p><figure><div data-height=350 data-theme-id=24311 data-slug-hash=abONWZr data-default-tab=result data-user=aurbano data-embed-version=2 class=codepen><a href=https://codepen.io/aurbano/pen/abONWZr/>See the Pen</a></div><figcaption><h4>Basic version of Reynolds' algorithm - <a title="View the source/edit in Codepen" target=_blank href="https://codepen.io/aurbano/pen/abONWZr?editors=0110">Codepen</a></h4></figcaption></figure><p>The algorithm clearly doesn&rsquo;t work that well yet, unsurprisingly since I&rsquo;ve made a lot of simplifications to Reynold&rsquo;s rules in order to quickly get something done that I can play with - but the good thing is that now I have the project setup (WebGL renderer setup, 2D boids arranged, turning of the sprites as they fly&mldr; ) so I can iterate fast <del title="Wait, wrong context!">and break things</del>.</p><p>At least there is <em>some</em> flocking behaviour though. I can clearly see the effects of cohesion, alignment, and separation so it&rsquo;s not a bad start!</p><p>Alhough I need a better way to <em>see</em> what the boids are doing, something that will give me an idea of what&rsquo;s happening <strong>over time</strong> in case there are other obvious problems with the algorithm, so I modified the code slightly to also render a heatmap based on the boids locations:</p><figure><div data-height=450 data-theme-id=24311 data-slug-hash=RwPajeY data-default-tab=result data-user=aurbano data-embed-version=2 class=codepen><a href=https://codepen.io/aurbano/pen/RwPajeY/>See the Pen</a></div><figcaption><h4>Heat map of the boids' locations over time - <a title="View the source/edit in Codepen" target=_blank href="https://codepen.io/aurbano/pen/RwPajeY?editors=0110">Codepen</a></h4></figcaption></figure><p>Thanks to the heatmap I can quickly identify a big issue with my simulation: I&rsquo;ve made the boids <em>wrap</em> around the edges of the simulation window as if it were a projected sphere. But boids on the opposite side are not currently taken into account for the distance when finding neighbours, meaning that the algorithm breaks near the edges of the simulation. Before I improve the algorithm I&rsquo;d like to fix that problem so that I get accurate visual feedback.</p><p>I have two options:</p><ul><li>Keep the wrapping, and include boids on the other side of the window (potentially more realistic).</li><li>Disable wrapping and instead make the boids prefer the center of the screen with another weak force (less realistic?).</li></ul><p>Calculating the distance either in a straight line or wrapping around the edges sounds complicated but it really isn&rsquo;t, since we can just use negative x/y values in the distance function.</p><figure><img src=https://aurbano.eu/posts/flocking/img/wrapping.png><figcaption><h4>Include boids wrapping around the simulation when calculating the distance to neighbours</h4></figcaption></figure><h4 id=next-steps>Next steps</h4><p>If I want to continue with this model I&rsquo;d need to make a modification so that each neighbour&rsquo;s contribution to the center of mass is scaled by the distance to the boid. The other issue is that this approach allows instant changes in direction, whereas in real life there should always be some delay - this makes me think that each boid should have the current direction, the desired direction, and perhaps <em>how much</em> they want to go in that direction. I also need to solve the problem with wrapping around the window, I might just remove that later and instead always make the boids <em>prefer</em> being closer to the center with a weak attraction.</p><p>Using this new approach, if there is a predator the desired direction will be to go away from it, and the <em>how much</em> part will be very high, depending on the predator&rsquo;s distance.</p><p>The other change I should make is that right now neighbours are calculated using only the distance. But real life animals can&rsquo;t see in 360 degrees, so I need to implement the concept of <strong>field of view</strong>.</p><p>So to recapitulate, for my second attempt I need:</p><ul><li>Boids Field of View</li><li>Desired Direction & Desire Strength</li></ul><p>I&rsquo;ll still simulate constant speed for now.</p><h3 id=second-iteration-boids-with-fov-and-non-instant-turning>Second Iteration: Boids with FoV and Non-Instant turning</h3><p>This article is still being written! The second iteration will come soon :)</p><p>You can preview the &ldquo;final product&rdquo; on <a href=https://aurbano.github.io/flock-webgl/>it&rsquo;s Github page</a>, currently in some stage between iteration 1 and 2.</p><script async src=https://assets.codepen.io/assets/embed/ei.js></script></div><div class="card related shadow"><div class=card-body><h5 class=card-title>More like this:</h5><div class=item><h6><a href=/post/2020-02-08-procedural-maps/>Procedural Map Generation</a>
<small class="date text-muted">February 8, 2020</small></h6></div><div class=item><h6><a href=/post/2015-03-03-front-end-sample/>Using the latest front-end tech</a>
<small class="date text-muted">March 3, 2015</small></h6></div><div class=item><h6><a href=/post/2014-10-21-making-of-nebula-text/>Making of Nebula text</a>
<small class="date text-muted">October 21, 2014</small></h6></div></div></div></div></div></div></main><footer><p class="copyright text-muted"><a href=/>Alejandro U. Alvarez</a>
Â© All rights reserved.
&bull;
<a href=/index.xml>RSS</a>
&bull;
<a href=/categories>Categories</a>
&bull;
<a href=/tags>Tags</a></p></footer><div class="border animated-hue"></div><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/javascript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/typescript.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://aurbano.eu/vendor/bootstrap/dist/js/bootstrap.bundle.min.js></script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script></body></html>